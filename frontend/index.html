<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Travel Planner</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .voice-btn {
            background-color: #28a745;
        }
        .voice-btn:hover {
            background-color: #218838;
        }
        .ai-btn {
            background-color: #6f42c1;
        }
        .ai-btn:hover {
            background-color: #5a32a3;
        }
        .logout-btn {
            background-color: #dc3545;
        }
        .logout-btn:hover {
            background-color: #c82333;
        }
        .auth-btn {
            background-color: #17a2b8;
        }
        .auth-btn:hover {
            background-color: #138496;
        }
        .plans-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .plan-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .map-container {
            height: 400px;
            background-color: #e9ecef;
            margin-top: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.loading {
            background-color: #cce7ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        .status.info {
            background-color: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        .plan-details {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            max-height: 500px;
            overflow-y: auto;
        }
        .api-info {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .auth-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .auth-form {
            background-color: white;
            margin: 100px auto;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }
        .close-btn {
            float: right;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
        }
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
    <div id="authModal" class="auth-container">
        <div class="auth-form">
            <span class="close-btn" id="closeAuthModal">&times;</span>
            <h2 id="authTitle">ç”¨æˆ·ç™»å½•</h2>
            <div id="authStatus"></div>
            <form id="authForm">
                <div class="form-group">
                    <label for="authUsername">ç”¨æˆ·å:</label>
                    <input type="text" id="authUsername" name="username" required>
                </div>
                <div class="form-group">
                    <label for="authPassword">å¯†ç :</label>
                    <input type="password" id="authPassword" name="password" required>
                </div>
                <div class="form-group" id="emailGroup" style="display: none;">
                    <label for="authEmail">é‚®ç®±:</label>
                    <input type="email" id="authEmail" name="email">
                </div>
                <button type="submit" id="authSubmitBtn">ç™»å½•</button>
                <button type="button" id="toggleAuthMode">æ²¡æœ‰è´¦æˆ·ï¼Ÿæ³¨å†Œ</button>
            </form>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>AI æ™ºèƒ½æ—…è¡Œè§„åˆ’å¸ˆ</h1>
            <p>é€šè¿‡è¯­éŸ³æˆ–æ–‡å­—è¾“å…¥æ‚¨çš„æ—…è¡Œéœ€æ±‚ï¼ŒAIå°†ä¸ºæ‚¨ç”Ÿæˆä¸ªæ€§åŒ–æ—…è¡Œè·¯çº¿</p>
            <div class="user-info">
                <div id="userInfo" style="display: none;">
                    æ¬¢è¿, <span id="usernameDisplay"></span>
                    <button id="logoutBtn" class="logout-btn">é€€å‡ºç™»å½•</button>
                </div>
                <div id="authButtons">
                    <button id="loginBtn" class="auth-btn">ç™»å½•</button>
                    <button id="registerBtn" class="auth-btn">æ³¨å†Œ</button>
                </div>
            </div>
        </header>

        <!-- APIé…ç½®æç¤º -->
        <div class="api-info">
            <strong>æç¤ºï¼š</strong>å½“å‰ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæ¼”ç¤ºã€‚è¦è¿æ¥çœŸå®çš„AIæœåŠ¡ï¼Œè¯·åœ¨é¡¹ç›®æ ¹ç›®å½•çš„.envæ–‡ä»¶ä¸­é…ç½®AI_API_KEYå’ŒAI_API_ENDPOINTã€‚
            <br>æ”¯æŒOpenAIå’Œé˜¿é‡Œäº‘ç™¾ç‚¼å¹³å°ç­‰æœåŠ¡ã€‚
        </div>

        <!-- è¯­éŸ³è¾“å…¥åŒºåŸŸ -->
        <div class="card">
            <h2>è¯­éŸ³è¾“å…¥æ—…è¡Œéœ€æ±‚</h2>
            <button id="voiceInput" class="voice-btn">ğŸ¤ ç‚¹å‡»è¯´è¯</button>
            <div id="voiceResult"></div>
        </div>

        <!-- æ–‡å­—è¾“å…¥åŒºåŸŸ -->
        <div class="card">
            <h2>æ–‡å­—è¾“å…¥æ—…è¡Œéœ€æ±‚</h2>
            <div id="statusMessage"></div>
            <form id="travelForm">
                <div class="form-group">
                    <label for="destination">ç›®çš„åœ°:</label>
                    <input type="text" id="destination" name="destination" required>
                </div>
                
                <div class="form-group">
                    <label for="startDate">å‡ºå‘æ—¥æœŸ:</label>
                    <input type="date" id="startDate" name="startDate" required>
                </div>
                
                <div class="form-group">
                    <label for="endDate">ç»“æŸæ—¥æœŸ:</label>
                    <input type="date" id="endDate" name="endDate" required>
                </div>
                
                <div class="form-group">
                    <label for="budget">é¢„ç®— (å…ƒ):</label>
                    <input type="number" id="budget" name="budget" required min="0">
                </div>
                
                <div class="form-group">
                    <label for="travelers">æ—…è¡Œäººæ•°:</label>
                    <input type="number" id="travelers" name="travelers" value="1" min="1">
                </div>
                
                <div class="form-group">
                    <label for="preferences">æ—…è¡Œåå¥½:</label>
                    <textarea id="preferences" name="preferences" rows="3" placeholder="ä¾‹å¦‚ï¼šå–œæ¬¢ç¾é£Ÿå’ŒåŠ¨æ¼«ï¼Œå¸¦å­©å­"></textarea>
                </div>
                
                <button type="submit" class="ai-btn">ğŸ¤– AIç”Ÿæˆæ—…è¡Œè®¡åˆ’</button>
                <button type="button" id="manualCreateBtn">â• æ‰‹åŠ¨åˆ›å»ºæ—…è¡Œè®¡åˆ’</button>
            </form>
        </div>

        <!-- ç”Ÿæˆçš„æ—…è¡Œè®¡åˆ’å±•ç¤ºåŒºåŸŸ -->
        <div class="card" id="generatedPlanSection" style="display: none;">
            <h2>AIç”Ÿæˆçš„æ—…è¡Œè®¡åˆ’</h2>
            <div id="generatedPlanContent" class="plan-details"></div>
        </div>

        <!-- åœ°å›¾å±•ç¤ºåŒºåŸŸ -->
        <div class="card">
            <h2>æ—…è¡Œè·¯çº¿åœ°å›¾</h2>
            <div id="map" class="map-container"></div>
        </div>

        <!-- æ—…è¡Œè®¡åˆ’å±•ç¤ºåŒºåŸŸ -->
        <div class="card">
            <h2>æˆ‘çš„æ—…è¡Œè®¡åˆ’</h2>
            <div class="plans-container" id="plansContainer">
                <!-- æ—…è¡Œè®¡åˆ’å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- è´¹ç”¨ç®¡ç†åŒºåŸŸ -->
        <div class="card">
            <h2>è´¹ç”¨ç®¡ç†</h2>
            <div id="selectedPlanInfo" class="status info" style="display: none;">
                å½“å‰é€‰æ‹©çš„è®¡åˆ’: <span id="selectedPlanTitle"></span>
            </div>
            <button id="voiceExpenseBtn" class="voice-btn">ğŸ¤ è¯­éŸ³è¾“å…¥è´¹ç”¨</button>
            <div id="voiceExpenseResult"></div>
            <form id="expenseForm">
                <input type="hidden" id="expensePlanId" name="plan_id">
                <div class="form-group">
                    <label for="expenseCategory">è´¹ç”¨ç±»åˆ«:</label>
                    <select id="expenseCategory" name="category">
                        <option value="äº¤é€š">äº¤é€š</option>
                        <option value="ä½å®¿">ä½å®¿</option>
                        <option value="é¤é¥®">é¤é¥®</option>
                        <option value="é—¨ç¥¨">é—¨ç¥¨</option>
                        <option value="è´­ç‰©">è´­ç‰©</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="expenseAmount">é‡‘é¢ (å…ƒ):</label>
                    <input type="number" id="expenseAmount" name="amount" required min="0" step="0.01">
                </div>
                
                <div class="form-group">
                    <label for="expenseDescription">æè¿°:</label>
                    <input type="text" id="expenseDescription" name="description" required>
                </div>
                
                <button type="submit">è®°å½•è´¹ç”¨</button>
                <button type="button" id="analyzeBudgetBtn" class="ai-btn">ğŸ¤– AIé¢„ç®—åˆ†æ</button>
            </form>
            <div id="budgetAnalysisResult" class="plan-details" style="display: none;"></div>
        </div>
    </div>

    <!-- å¼•å…¥é«˜å¾·åœ°å›¾API -->
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.15&key=YOUR_AMAP_API_KEY"></script>
    <script>
        // å…¨å±€å˜é‡
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let map = null;
        let markers = [];
        
        // åˆå§‹åŒ–é«˜å¾·åœ°å›¾
        function initMap() {
            // åˆ›å»ºåœ°å›¾å®ä¾‹
            map = new AMap.Map('map', {
                zoom: 13,
                center: [116.397428, 39.90923] // é»˜è®¤åŒ—äº¬å¤©å®‰é—¨
            });
            
            // å¯ç”¨æ»šè½®ç¼©æ”¾
            map.setStatus({
                scrollWheel: true
            });
            
            // æ·»åŠ é»˜è®¤æ ‡è®°
            var marker = new AMap.Marker({
                position: new AMap.LngLat(116.397428, 39.90923),
                title: 'é»˜è®¤ä½ç½®'
            });
            map.add(marker);
            markers.push(marker);
        }
        
        // æ›´æ–°åœ°å›¾æ˜¾ç¤ºç‰¹å®šç›®çš„åœ°
        function updateMapWithDestination(destination) {
            // åˆ›å»ºåœ°ç†ç¼–ç å®ä¾‹
            var geocoder = new AMap.Geocoder({
                city: "å…¨å›½", // åŸå¸‚ï¼Œé»˜è®¤ï¼š"å…¨å›½"
                radius: 1000 //èŒƒå›´ï¼Œé»˜è®¤ï¼š500
            });
            
            // æ¸…é™¤ä¹‹å‰çš„æ ‡è®°
            markers.forEach(marker => map.remove(marker));
            markers = [];
            
            // å°†åœ°å€è§£æä¸ºåæ ‡ç‚¹
            geocoder.getLocation(destination, function(status, result) {
                if (status === 'complete' && result.info === 'OK') {
                    if (result.geocodes.length > 0) {
                        // è·å–ç¬¬ä¸€ä¸ªç»“æœçš„åæ ‡
                        var location = result.geocodes[0].location;
                        
                        // è®¾ç½®åœ°å›¾ä¸­å¿ƒç‚¹
                        map.setCenter([location.lng, location.lat]);
                        map.setZoom(14); // è®¾ç½®åˆé€‚çš„ç¼©æ”¾çº§åˆ«
                        
                        // æ·»åŠ æ–°æ ‡è®°
                        var marker = new AMap.Marker({
                            position: location,
                            title: "ç›®çš„åœ°: " + destination
                        });
                        map.add(marker);
                        markers.push(marker);
                        
                        // æ·»åŠ ä¿¡æ¯çª—å£
                        var infoWindow = new AMap.InfoWindow({
                            content: "ç›®çš„åœ°: " + destination,
                            offset: new AMap.Pixel(0, -30)
                        });
                        infoWindow.open(map, location);
                    }
                } else {
                    showStatus('æ— æ³•æ‰¾åˆ°ç›®çš„åœ° "' + destination + '" çš„ä½ç½®ä¿¡æ¯', 'error');
                }
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯çŠ¶æ€
        document.addEventListener('DOMContentLoaded', async function() {
            // åˆå§‹åŒ–åœ°å›¾
            initMap();
            
            if (authToken) {
                // éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§
                const isValid = await validateToken();
                if (isValid) {
                    showUserInterface();
                    loadUserTravelPlans();
                } else {
                    logout();
                }
            }
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©ä¹‹å
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').min = today;
            document.getElementById('endDate').min = today;
        });
        
        // éªŒè¯ä»¤ç‰Œ
        async function validateToken() {
            try {
                const response = await fetch('/auth/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    currentUser = user;
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Token validation error:', error);
                return false;
            }
        }
        
        // æ˜¾ç¤ºç”¨æˆ·ç•Œé¢
        function showUserInterface() {
            document.getElementById('authButtons').style.display = 'none';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('usernameDisplay').textContent = currentUser.username;
        }
        
        // éšè—ç”¨æˆ·ç•Œé¢
        function hideUserInterface() {
            document.getElementById('authButtons').style.display = 'block';
            document.getElementById('userInfo').style.display = 'none';
        }
        
        // ç™»å½•æŒ‰é’®äº‹ä»¶
        document.getElementById('loginBtn').addEventListener('click', function() {
            document.getElementById('authTitle').textContent = 'ç”¨æˆ·ç™»å½•';
            document.getElementById('authSubmitBtn').textContent = 'ç™»å½•';
            document.getElementById('emailGroup').style.display = 'none';
            document.getElementById('toggleAuthMode').textContent = 'æ²¡æœ‰è´¦æˆ·ï¼Ÿæ³¨å†Œ';
            document.getElementById('authModal').style.display = 'block';
        });
        
        // æ³¨å†ŒæŒ‰é’®äº‹ä»¶
        document.getElementById('registerBtn').addEventListener('click', function() {
            document.getElementById('authTitle').textContent = 'ç”¨æˆ·æ³¨å†Œ';
            document.getElementById('authSubmitBtn').textContent = 'æ³¨å†Œ';
            document.getElementById('emailGroup').style.display = 'block';
            document.getElementById('toggleAuthMode').textContent = 'å·²æœ‰è´¦æˆ·ï¼Ÿç™»å½•';
            document.getElementById('authModal').style.display = 'block';
        });
        
        // å…³é—­æ¨¡æ€æ¡†
        document.getElementById('closeAuthModal').addEventListener('click', function() {
            document.getElementById('authModal').style.display = 'none';
        });
        
        // åˆ‡æ¢è®¤è¯æ¨¡å¼
        document.getElementById('toggleAuthMode').addEventListener('click', function() {
            const title = document.getElementById('authTitle').textContent;
            if (title === 'ç”¨æˆ·ç™»å½•') {
                document.getElementById('authTitle').textContent = 'ç”¨æˆ·æ³¨å†Œ';
                document.getElementById('authSubmitBtn').textContent = 'æ³¨å†Œ';
                document.getElementById('emailGroup').style.display = 'block';
                document.getElementById('toggleAuthMode').textContent = 'å·²æœ‰è´¦æˆ·ï¼Ÿç™»å½•';
            } else {
                document.getElementById('authTitle').textContent = 'ç”¨æˆ·ç™»å½•';
                document.getElementById('authSubmitBtn').textContent = 'ç™»å½•';
                document.getElementById('emailGroup').style.display = 'none';
                document.getElementById('toggleAuthMode').textContent = 'æ²¡æœ‰è´¦æˆ·ï¼Ÿæ³¨å†Œ';
            }
        });
        
        // è®¤è¯è¡¨å•æäº¤
        document.getElementById('authForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('authTitle').textContent;
            const username = document.getElementById('authUsername').value;
            const password = document.getElementById('authPassword').value;
            
            try {
                if (title === 'ç”¨æˆ·ç™»å½•') {
                    // ç™»å½•
                    // ä½¿ç”¨FormDataæ ¼å¼å‘é€æ•°æ®
                    const formData = new FormData();
                    formData.append('username', username);
                    formData.append('password', password);
                    
                    const response = await fetch('/auth/login', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        authToken = data.access_token;
                        localStorage.setItem('authToken', authToken);
                        
                        // è·å–ç”¨æˆ·ä¿¡æ¯
                        const userResponse = await fetch('/auth/me', {
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            }
                        });
                        
                        if (userResponse.ok) {
                            currentUser = await userResponse.json();
                            showUserInterface();
                            document.getElementById('authModal').style.display = 'none';
                            document.getElementById('authForm').reset();
                            showAuthStatus('ç™»å½•æˆåŠŸï¼', 'success');
                            loadUserTravelPlans();
                        } else {
                            const errorText = await userResponse.text();
                            showAuthStatus('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + errorText, 'error');
                        }
                    } else {
                        // å°è¯•è§£æé”™è¯¯å“åº”ï¼Œå¦‚æœå¤±è´¥åˆ™æ˜¾ç¤ºé€šç”¨é”™è¯¯æ¶ˆæ¯
                        try {
                            const error = await response.json();
                            showAuthStatus(error.detail || 'ç™»å½•å¤±è´¥: ' + response.statusText, 'error');
                        } catch (parseError) {
                            const errorText = await response.text();
                            showAuthStatus('ç™»å½•å¤±è´¥: ' + errorText, 'error');
                        }
                    }
                } else {
                    // æ³¨å†Œ
                    const email = document.getElementById('authEmail').value;
                    
                    // ä½¿ç”¨FormDataæ ¼å¼å‘é€æ•°æ®
                    const formData = new FormData();
                    formData.append('username', username);
                    formData.append('password', password);
                    formData.append('email', email);
                    
                    const response = await fetch('/auth/register', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const user = await response.json();
                        showAuthStatus('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•', 'success');
                        // åˆ‡æ¢åˆ°ç™»å½•æ¨¡å¼
                        document.getElementById('authTitle').textContent = 'ç”¨æˆ·ç™»å½•';
                        document.getElementById('authSubmitBtn').textContent = 'ç™»å½•';
                        document.getElementById('emailGroup').style.display = 'none';
                        document.getElementById('toggleAuthMode').textContent = 'æ²¡æœ‰è´¦æˆ·ï¼Ÿæ³¨å†Œ';
                        document.getElementById('authForm').reset();
                    } else {
                        // å°è¯•è§£æé”™è¯¯å“åº”ï¼Œå¦‚æœå¤±è´¥åˆ™æ˜¾ç¤ºé€šç”¨é”™è¯¯æ¶ˆæ¯
                        try {
                            const error = await response.json();
                            showAuthStatus(error.detail || 'æ³¨å†Œå¤±è´¥: ' + response.statusText, 'error');
                        } catch (parseError) {
                            const errorText = await response.text();
                            showAuthStatus('æ³¨å†Œå¤±è´¥: ' + errorText, 'error');
                        }
                    }
                }
            } catch (error) {
                console.error('Auth error:', error);
                showAuthStatus('è®¤è¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            }
        });
        
        // é€€å‡ºç™»å½•
        document.getElementById('logoutBtn').addEventListener('click', logout);
        
        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            hideUserInterface();
            document.getElementById('plansContainer').innerHTML = '';
            showStatus('å·²é€€å‡ºç™»å½•', 'info');
        }
        
        // æ˜¾ç¤ºè®¤è¯çŠ¶æ€æ¶ˆæ¯
        function showAuthStatus(message, type) {
            const statusDiv = document.getElementById('authStatus');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            
            // 3ç§’åè‡ªåŠ¨æ¸…é™¤æ¶ˆæ¯
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 3000);
        }
        
        // åŠ è½½ç”¨æˆ·æ—…è¡Œè®¡åˆ’
        async function loadUserTravelPlans() {
            if (!authToken) return;
            
            try {
                const response = await fetch('/api/plans/', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const plans = await response.json();
                    displayTravelPlans(plans);
                } else {
                    console.error('Failed to load travel plans');
                }
            } catch (error) {
                console.error('Error loading travel plans:', error);
            }
        }
        
        // æ˜¾ç¤ºæ—…è¡Œè®¡åˆ’
        function displayTravelPlans(plans) {
            const container = document.getElementById('plansContainer');
            container.innerHTML = '';
            
            if (plans.length === 0) {
                container.innerHTML = '<p>æš‚æ— æ—…è¡Œè®¡åˆ’</p>';
                return;
            }
            
            plans.forEach(plan => {
                const planCard = document.createElement('div');
                planCard.className = 'plan-card';
                planCard.innerHTML = `
                    <h3>${plan.title}</h3>
                    <p><strong>æ—¶é—´:</strong> ${new Date(plan.start_date).toLocaleDateString()} è‡³ ${new Date(plan.end_date).toLocaleDateString()}</p>
                    <p><strong>é¢„ç®—:</strong> Â¥${plan.budget}</p>
                    <p><strong>åå¥½:</strong> ${plan.preferences || 'æ— '}</p>
                    <button class="select-plan-btn" data-plan-id="${plan.id}">é€‰æ‹©æ­¤è®¡åˆ’</button>
                    <button class="edit-plan-btn" data-plan-id="${plan.id}">ç¼–è¾‘è®¡åˆ’</button>
                    <button class="delete-plan-btn" data-plan-id="${plan.id}">åˆ é™¤è®¡åˆ’</button>
                    <button class="show-map-btn" data-destination="${plan.destination}">æ˜¾ç¤ºåœ°å›¾</button>
                `;
                container.appendChild(planCard);
            });
            
            // ç§»é™¤ä¹‹å‰å¯èƒ½æ·»åŠ çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
            const selectButtons = document.querySelectorAll('.select-plan-btn');
            selectButtons.forEach(button => {
                const clone = button.cloneNode(true);
                button.parentNode.replaceChild(clone, button);
            });
            
            // ä¸ºæ–°æ·»åŠ çš„é€‰æ‹©æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('.select-plan-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    const planId = this.getAttribute('data-plan-id');
                    const planTitle = this.closest('.plan-card').querySelector('h3').textContent;
                    
                    // è®¾ç½®è¡¨å•ä¸­çš„è®¡åˆ’ID
                    document.getElementById('expensePlanId').value = planId;
                    
                    // æ˜¾ç¤ºé€‰ä¸­çš„è®¡åˆ’ä¿¡æ¯
                    document.getElementById('selectedPlanInfo').style.display = 'block';
                    document.getElementById('selectedPlanTitle').textContent = planTitle;
                    
                    // æ¸…é™¤ä¹‹å‰çš„é¢„ç®—åˆ†æç»“æœ
                    document.getElementById('budgetAnalysisResult').style.display = 'none';
                    
                    // è·å–è®¡åˆ’è¯¦ç»†ä¿¡æ¯å¹¶æ›´æ–°åœ°å›¾
                    try {
                        const response = await fetch(`/api/plans/${planId}`, {
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            }
                        });
                        
                        if (response.ok) {
                            const plan = await response.json();
                            updateMapWithDestination(plan.destination);
                        } else {
                            console.error('Failed to fetch plan details');
                            showStatus('è·å–è®¡åˆ’è¯¦æƒ…å¤±è´¥', 'error');
                        }
                    } catch (error) {
                        console.error('Error fetching plan details:', error);
                        showStatus('è·å–è®¡åˆ’è¯¦æƒ…æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
                    }
                });
            });
            
            // ä¸ºæ–°æ·»åŠ çš„ç¼–è¾‘æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('.edit-plan-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const planId = this.getAttribute('data-plan-id');
                    // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥æ‰“å¼€ä¸€ä¸ªç¼–è¾‘æ¨¡æ€æ¡†
                    alert(`ç¼–è¾‘è®¡åˆ’åŠŸèƒ½å°†åœ¨å®Œæ•´å®ç°ä¸­æä¾›ï¼Œè®¡åˆ’ID: ${planId}`);
                    // ç®€å•ç¤ºä¾‹ï¼šç›´æ¥è·³è½¬åˆ°AIç”Ÿæˆé¡µé¢å¹¶é¢„å¡«å……æ•°æ®
                    // è¿™åªæ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå®é™…å®ç°åº”è¯¥æ›´å®Œæ•´
                });
            });
            
            // ä¸ºæ–°æ·»åŠ çš„åˆ é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('.delete-plan-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    const planId = this.getAttribute('data-plan-id');
                    const planCard = this.closest('.plan-card');
                    const planTitle = planCard.querySelector('h3').textContent;
                    
                    if (confirm(`ç¡®å®šè¦åˆ é™¤æ—…è¡Œè®¡åˆ’ "${planTitle}" å—ï¼Ÿ`)) {
                        try {
                            const response = await fetch(`/api/plans/${planId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': `Bearer ${authToken}`
                                }
                            });
                            
                            if (response.ok) {
                                showStatus('æ—…è¡Œè®¡åˆ’åˆ é™¤æˆåŠŸï¼', 'success');
                                // é‡æ–°åŠ è½½ç”¨æˆ·çš„æ—…è¡Œè®¡åˆ’
                                loadUserTravelPlans();
                            } else {
                                const error = await response.json();
                                showStatus('åˆ é™¤æ—…è¡Œè®¡åˆ’å¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                            }
                        } catch (error) {
                            console.error('Error deleting travel plan:', error);
                            showStatus('åˆ é™¤æ—…è¡Œè®¡åˆ’æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
                        }
                    }
                });
            });
            
            // ä¸ºæ–°æ·»åŠ çš„æ˜¾ç¤ºåœ°å›¾æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('.show-map-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const destination = this.getAttribute('data-destination');
                    updateMapWithDestination(destination);
                });
            });
        }
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            
            // 5ç§’åè‡ªåŠ¨æ¸…é™¤æ¶ˆæ¯
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 5000);
        }

        // æ˜¾ç¤ºç”Ÿæˆçš„æ—…è¡Œè®¡åˆ’
        function showGeneratedPlan(planContent) {
            const planSection = document.getElementById('generatedPlanSection');
            const planContentDiv = document.getElementById('generatedPlanContent');
            
            planContentDiv.innerHTML = planContent.replace(/\n/g, '<br>');
            planSection.style.display = 'block';
            
            // æ»šåŠ¨åˆ°è®¡åˆ’å±•ç¤ºåŒºåŸŸ
            planSection.scrollIntoView({ behavior: 'smooth' });
        }

        // è¯­éŸ³è¾“å…¥åŠŸèƒ½
        document.getElementById('voiceInput').addEventListener('click', async function() {
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            if (!authToken) {
                showStatus('è¯·å…ˆç™»å½•ä»¥ä½¿ç”¨è¯­éŸ³è¾“å…¥åŠŸèƒ½', 'error');
                return;
            }
            
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³è¯†åˆ«
            if ('webkitSpeechRecognition' in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.lang = 'zh-CN'; // è®¾ç½®è¯­è¨€ä¸ºä¸­æ–‡
                recognition.continuous = false; // ä¸æŒç»­è¯†åˆ«
                recognition.interimResults = false; // ä¸è¿”å›ä¸­é—´ç»“æœ
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('voiceResult').innerHTML = `<p>è¯†åˆ«ç»“æœï¼š${transcript}</p>`;
                    // è§£æè¯­éŸ³è¾“å…¥å¹¶å¡«å……åˆ°è¡¨å•
                    parseTravelRequest(transcript);
                };
                
                recognition.onerror = function(event) {
                    console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                    document.getElementById('voiceResult').innerHTML = `<p>è¯­éŸ³è¯†åˆ«å‡ºé”™: ${event.error}</p>`;
                    showStatus('è¯­éŸ³è¯†åˆ«å‡ºé”™: ' + event.error, 'error');
                };
                
                recognition.onend = function() {
                    showStatus('è¯­éŸ³è¯†åˆ«å®Œæˆ', 'success');
                };
                
                recognition.start();
                showStatus('æ­£åœ¨å½•éŸ³ï¼Œè¯·è¯´è¯...', 'info');
            } else {
                // æµè§ˆå™¨ä¸æ”¯æŒWeb Speech APIï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½ï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®è¿›è¡Œæ¼”ç¤ºã€‚');
                
                // ç¤ºä¾‹æ•°æ®
                const exampleText = "æˆ‘æƒ³å»æ—¥æœ¬ï¼Œ5å¤©ï¼Œé¢„ç®—1ä¸‡å…ƒï¼Œå–œæ¬¢ç¾é£Ÿå’ŒåŠ¨æ¼«ï¼Œå¸¦å­©å­";
                document.getElementById('voiceResult').innerHTML = `<p>è¯†åˆ«ç»“æœï¼š${exampleText}</p>`;
                
                // è§£æè¯­éŸ³è¾“å…¥å¹¶å¡«å……åˆ°è¡¨å•
                parseTravelRequest(exampleText);
            }
        });
        
        // è§£ææ—…è¡Œè¯·æ±‚å¹¶å¡«å……è¡¨å•
        function parseTravelRequest(text) {
            // è¿™é‡Œåº”è¯¥å®ç°æ›´å¤æ‚çš„è‡ªç„¶è¯­è¨€å¤„ç†é€»è¾‘
            // ç®€å•ç¤ºä¾‹ï¼šé€šè¿‡å…³é”®è¯åŒ¹é…æå–ä¿¡æ¯
            console.log("è§£æè¯­éŸ³è¾“å…¥:", text);
            
            // åŒ¹é…ç›®çš„åœ° (å»|åˆ°|å‰å¾€)(æŸä¸ªåœ°æ–¹)
            const destinationPatterns = [
                /å»(.+?)(?:æ—…è¡Œ|æ—…æ¸¸|ç©|é€›)/,
                /åˆ°(.+?)(?:æ—…è¡Œ|æ—…æ¸¸|ç©|é€›)/,
                /å‰å¾€(.+?)(?:æ—…è¡Œ|æ—…æ¸¸|ç©|é€›)/,
                /å»(.+?)[ï¼Œ,]/,
                /åˆ°(.+?)[ï¼Œ,]/,
                /å‰å¾€(.+?)[ï¼Œ,]/
            ];
            
            let destination = null;
            for (const pattern of destinationPatterns) {
                const match = text.match(pattern);
                if (match) {
                    destination = match[1].trim();
                    break;
                }
            }
            
            // å¦‚æœè¿˜æ²¡åŒ¹é…åˆ°ï¼Œå°è¯•æ›´ç®€å•çš„åŒ¹é…
            if (!destination) {
                const simpleMatch = text.match(/å»(.+?)[\sï¼Œ,]/);
                if (simpleMatch) {
                    destination = simpleMatch[1].trim();
                }
            }
            
            // åŒ¹é…å¤©æ•°
            let days = null;
            const daysMatch = text.match(/(\d+)å¤©/);
            if (daysMatch) {
                days = parseInt(daysMatch[1]);
            }
            
            // åŒ¹é…é¢„ç®—
            let budget = null;
            const budgetPatterns = [
                /é¢„ç®—(\d+)å…ƒ/,
                /(\d+)å…ƒé¢„ç®—/,
                /èŠ±è´¹(\d+)å…ƒ/,
                /(\d+)å…ƒäººæ°‘å¸/
            ];
            
            for (const pattern of budgetPatterns) {
                const match = text.match(pattern);
                if (match) {
                    budget = match[1];
                    break;
                }
            }
            
            // åŒ¹é…åå¥½
            let preferences = "";
            const preferencePatterns = [
                /å–œæ¬¢(.+?)[ï¼Œ,]/,
                /çˆ±å¥½(.+?)[ï¼Œ,]/,
                /åçˆ±(.+?)[ï¼Œ,]/
            ];
            
            for (const pattern of preferencePatterns) {
                const match = text.match(pattern);
                if (match) {
                    preferences = match[1];
                    break;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦å¸¦å­©å­
            if (text.includes("å¸¦å­©å­") || text.includes("å¸¦å°å­©") || text.includes("æœ‰å­©å­")) {
                preferences += (preferences ? "ï¼Œ" : "") + "å¸¦å­©å­";
            }
            
            // å¡«å……è¡¨å•
            if (destination) {
                document.getElementById('destination').value = destination;
            }
            
            if (days) {
                const startDate = new Date();
                const endDate = new Date();
                endDate.setDate(startDate.getDate() + days);
                
                document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            }
            
            if (budget) {
                document.getElementById('budget').value = budget;
            }
            
            if (preferences) {
                document.getElementById('preferences').value = preferences;
            }
            
            showStatus('è¯­éŸ³è¯†åˆ«ç»“æœå·²å¡«å……åˆ°è¡¨å•ä¸­', 'success');
        }

        // æ—…è¡Œè®¡åˆ’ç”ŸæˆåŠŸèƒ½
        document.getElementById('travelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            if (!authToken) {
                showStatus('è¯·å…ˆç™»å½•ä»¥ä¿å­˜æ—…è¡Œè®¡åˆ’', 'error');
                return;
            }
            
            // è·å–è¡¨å•æ•°æ®
            const formData = new FormData(this);
            const travelData = {
                destination: formData.get('destination'),
                start_date: formData.get('startDate'),
                end_date: formData.get('endDate'),
                budget: parseFloat(formData.get('budget')),
                travelers: parseInt(formData.get('travelers')) || 1,
                preferences: formData.get('preferences') || ""
            };
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!travelData.destination) {
                showStatus('è¯·å¡«å†™ç›®çš„åœ°', 'error');
                return;
            }
            
            if (!travelData.start_date || !travelData.end_date) {
                showStatus('è¯·é€‰æ‹©æ—…è¡Œæ—¥æœŸ', 'error');
                return;
            }
            
            if (travelData.budget <= 0) {
                showStatus('é¢„ç®—å¿…é¡»å¤§äº0', 'error');
                return;
            }
            
            if (travelData.travelers <= 0) {
                showStatus('æ—…è¡Œäººæ•°å¿…é¡»å¤§äº0', 'error');
                return;
            }
            
            try {
                showStatus('æ­£åœ¨ç”Ÿæˆæ—…è¡Œè®¡åˆ’ï¼Œè¯·ç¨å€™...', 'loading');
                
                // å‘é€POSTè¯·æ±‚ï¼Œå°†æ•°æ®æ”¾åœ¨è¯·æ±‚ä½“ä¸­
                const response = await fetch('/api/plans/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(travelData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showStatus('æ—…è¡Œè®¡åˆ’å·²ç”Ÿæˆï¼', 'success');
                    // æ˜¾ç¤ºç”Ÿæˆçš„è®¡åˆ’å†…å®¹
                    console.log('Received plan:', result); // è°ƒè¯•ä¿¡æ¯
                    
                    // å°è¯•å¤šç§æ–¹å¼è·å–è®¡åˆ’å†…å®¹
                    let planContent = 'æœªæ‰¾åˆ°æ—…è¡Œè®¡åˆ’å†…å®¹';
                    if (result.details) {
                        planContent = result.details;
                    } else if (result.ai_response) {
                        planContent = result.ai_response;
                    } else {
                        // å¦‚æœä»¥ä¸Šéƒ½æ²¡æœ‰ï¼Œå°è¯•æ˜¾ç¤ºæ•´ä¸ªå“åº”å¯¹è±¡
                        planContent = JSON.stringify(result, null, 2);
                    }
                    
                    showGeneratedPlan(planContent);
                    
                    // æ›´æ–°åœ°å›¾æ˜¾ç¤ºç›®çš„åœ°
                    updateMapWithDestination(travelData.destination);
                    
                    // é‡æ–°åŠ è½½ç”¨æˆ·çš„æ—…è¡Œè®¡åˆ’
                    loadUserTravelPlans();
                } else {
                    const error = await response.json();
                    let errorMessage = error.detail || 'æœªçŸ¥é”™è¯¯';
                    
                    // æä¾›æ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯
                    if (errorMessage.includes('AI APIå¯†é’¥æˆ–ç«¯ç‚¹æœªé…ç½®')) {
                        errorMessage = 'å½“å‰ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæ¼”ç¤ºã€‚è¦è¿æ¥çœŸå®çš„AIæœåŠ¡ï¼Œè¯·åœ¨.envæ–‡ä»¶ä¸­é…ç½®AI_API_KEYå’ŒAI_API_ENDPOINTã€‚';
                    }
                    
                    showStatus('ç”Ÿæˆæ—…è¡Œè®¡åˆ’å¤±è´¥: ' + errorMessage, 'error');
                }
                
            } catch (error) {
                console.error('Error generating travel plan:', error); // è°ƒè¯•ä¿¡æ¯
                showStatus('ç”Ÿæˆæ—…è¡Œè®¡åˆ’æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            }
        });

        // æ‰‹åŠ¨åˆ›å»ºæ—…è¡Œè®¡åˆ’åŠŸèƒ½
        document.getElementById('manualCreateBtn').addEventListener('click', async function() {
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            if (!authToken) {
                showStatus('è¯·å…ˆç™»å½•ä»¥åˆ›å»ºæ—…è¡Œè®¡åˆ’', 'error');
                return;
            }
            
            // è·å–è¡¨å•æ•°æ®
            const formData = new FormData(document.getElementById('travelForm'));
            const startDate = formData.get('startDate');
            const endDate = formData.get('endDate');
            
            const travelData = {
                title: `${formData.get('destination') || 'æœªå‘½åç›®çš„åœ°'}æ—…è¡Œè®¡åˆ’`,
                destination: formData.get('destination'),
                start_date: startDate ? new Date(startDate).toISOString() : null,
                end_date: endDate ? new Date(endDate).toISOString() : null,
                budget: parseFloat(formData.get('budget')) || 0,
                preferences: formData.get('preferences') || ""
            };
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!travelData.destination) {
                showStatus('è¯·å¡«å†™ç›®çš„åœ°', 'error');
                return;
            }
            
            if (!startDate || !endDate) {
                showStatus('è¯·é€‰æ‹©æ—…è¡Œæ—¥æœŸ', 'error');
                return;
            }
            
            if (travelData.budget <= 0) {
                showStatus('é¢„ç®—å¿…é¡»å¤§äº0', 'error');
                return;
            }
            
            try {
                // å‘é€POSTè¯·æ±‚åˆ›å»ºæ—…è¡Œè®¡åˆ’
                const response = await fetch('/api/plans/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(travelData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showStatus('æ—…è¡Œè®¡åˆ’åˆ›å»ºæˆåŠŸï¼', 'success');
                    // æ›´æ–°åœ°å›¾æ˜¾ç¤ºç›®çš„åœ°
                    updateMapWithDestination(travelData.destination);
                    // é‡æ–°åŠ è½½ç”¨æˆ·çš„æ—…è¡Œè®¡åˆ’
                    loadUserTravelPlans();
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('travelForm').reset();
                } else {
                    const error = await response.json();
                    showStatus('åˆ›å»ºæ—…è¡Œè®¡åˆ’å¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('Error creating travel plan:', error);
                showStatus('åˆ›å»ºæ—…è¡Œè®¡åˆ’æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            }
        });

        // è´¹ç”¨è®°å½•åŠŸèƒ½
        document.getElementById('expenseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            if (!authToken) {
                alert('è¯·å…ˆç™»å½•ä»¥è®°å½•è´¹ç”¨');
                return;
            }
            
            const formData = new FormData(this);
            const expenseData = {
                plan_id: parseInt(formData.get('plan_id')) || 1, // é»˜è®¤ä½¿ç”¨è®¡åˆ’ID 1è¿›è¡Œæµ‹è¯•
                category: formData.get('category'),
                amount: parseFloat(formData.get('amount')),
                description: formData.get('description'),
                expense_date: new Date().toISOString() // æ·»åŠ å½“å‰æ—¶é—´ä½œä¸ºè´¹ç”¨æ—¥æœŸ
            };
            
            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†è®¡åˆ’
            if (!expenseData.plan_id) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ—…è¡Œè®¡åˆ’');
                return;
            }
            
            try {
                const response = await fetch('/api/expenses/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(expenseData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('è´¹ç”¨è®°å½•æˆåŠŸï¼');
                    this.reset();
                    
                    // ä¿æŒè®¡åˆ’ID
                    document.getElementById('expensePlanId').value = expenseData.plan_id;
                    
                    // æ›´æ–°é¢„ç®—åˆ†æç»“æœåŒºåŸŸï¼ˆå¦‚æœå·²æ˜¾ç¤ºï¼‰
                    if (document.getElementById('budgetAnalysisResult').style.display !== 'none') {
                        document.getElementById('analyzeBudgetBtn').click();
                    }
                } else {
                    const error = await response.json();
                    alert('è´¹ç”¨è®°å½•å¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('Error recording expense:', error);
                alert('è´¹ç”¨è®°å½•æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            }
        });
        
        // è¯­éŸ³è¾“å…¥è´¹ç”¨åŠŸèƒ½
        document.getElementById('voiceExpenseBtn').addEventListener('click', function() {
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³è¯†åˆ«
            if ('webkitSpeechRecognition' in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.lang = 'zh-CN'; // è®¾ç½®è¯­è¨€ä¸ºä¸­æ–‡
                recognition.continuous = false; // ä¸æŒç»­è¯†åˆ«
                recognition.interimResults = false; // ä¸è¿”å›ä¸­é—´ç»“æœ
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('voiceExpenseResult').innerHTML = `<p>è¯†åˆ«ç»“æœï¼š${transcript}</p>`;
                    // è§£æè¯­éŸ³è¾“å…¥å¹¶å¡«å……åˆ°è´¹ç”¨è¡¨å•
                    parseExpenseRequest(transcript);
                };
                
                recognition.onerror = function(event) {
                    console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                    document.getElementById('voiceExpenseResult').innerHTML = `<p>è¯­éŸ³è¯†åˆ«å‡ºé”™: ${event.error}</p>`;
                    showStatus('è´¹ç”¨è¯­éŸ³è¯†åˆ«å‡ºé”™: ' + event.error, 'error');
                };
                
                recognition.onend = function() {
                    showStatus('è´¹ç”¨è¯­éŸ³è¯†åˆ«å®Œæˆ', 'success');
                };
                
                recognition.start();
                showStatus('æ­£åœ¨å½•éŸ³ï¼Œè¯·è¯´è¯...', 'info');
            } else {
                // æµè§ˆå™¨ä¸æ”¯æŒWeb Speech APIï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½ï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®è¿›è¡Œæ¼”ç¤ºã€‚');
                document.getElementById('voiceExpenseResult').innerHTML = '<p>ç¤ºä¾‹è¯†åˆ«ç»“æœï¼šé¤é¥® 128å…ƒ åˆé¤é¢æ¡</p>';
                
                // æ¨¡æ‹Ÿå¡«å……è¡¨å•
                document.getElementById('expenseCategory').value = 'é¤é¥®';
                document.getElementById('expenseAmount').value = '128';
                document.getElementById('expenseDescription').value = 'åˆé¤é¢æ¡';
            }
        });
        
        // è§£æè´¹ç”¨è¯·æ±‚å¹¶å¡«å……è¡¨å•
        function parseExpenseRequest(text) {
            console.log("è§£æè´¹ç”¨è¯­éŸ³è¾“å…¥:", text);
            
            // åŒ¹é…ç±»åˆ«
            const categories = {
                'é¤é¥®': ['é¤é¥®', 'åƒé¥­', 'åˆé¤', 'æ™šé¤', 'æ—©é¤', 'åƒ'],
                'äº¤é€š': ['äº¤é€š', 'è½¦è´¹', 'æ‰“è½¦', 'åœ°é“', 'å…¬äº¤', 'é£æœº', 'ç«è½¦'],
                'ä½å®¿': ['ä½å®¿', 'é…’åº—', 'å®¾é¦†', 'æ—…é¦†', 'æ°‘å®¿', 'ä½æˆ¿'],
                'é—¨ç¥¨': ['é—¨ç¥¨', 'ç¥¨ä»·', 'å…¥åœºè´¹', 'æ™¯ç‚¹'],
                'è´­ç‰©': ['è´­ç‰©', 'ä¹°ä¸œè¥¿', 'ä¹°è¡£æœ', 'é€›è¡—'],
                'å…¶ä»–': ['å…¶ä»–']
            };
            
            let category = 'å…¶ä»–';
            for (const [cat, keywords] of Object.entries(categories)) {
                if (keywords.some(keyword => text.includes(keyword))) {
                    category = cat;
                    break;
                }
            }
            
            // åŒ¹é…é‡‘é¢
            let amount = null;
            const amountMatch = text.match(/(\d+(?:\.\d{1,2})?)å…ƒ/);
            if (amountMatch) {
                amount = amountMatch[1];
            }
            
            // åŒ¹é…æè¿°
            let description = text;
            // ç§»é™¤ç±»åˆ«å’Œé‡‘é¢ä¿¡æ¯ï¼Œä¿ç•™æè¿°
            description = description.replace(/(é¤é¥®|äº¤é€š|ä½å®¿|é—¨ç¥¨|è´­ç‰©|å…¶ä»–)/g, '');
            description = description.replace(/(\d+(?:\.\d{1,2})?)å…ƒ/g, '').trim();
            
            // å¡«å……è¡¨å•
            document.getElementById('expenseCategory').value = category;
            
            if (amount) {
                document.getElementById('expenseAmount').value = amount;
            }
            
            if (description) {
                document.getElementById('expenseDescription').value = description;
            }
            
            showStatus('è´¹ç”¨è¯­éŸ³è¯†åˆ«ç»“æœå·²å¡«å……åˆ°è¡¨å•ä¸­', 'success');
        }
        
        // AIé¢„ç®—åˆ†æåŠŸèƒ½
        document.getElementById('analyzeBudgetBtn').addEventListener('click', async function() {
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            if (!authToken) {
                alert('è¯·å…ˆç™»å½•ä»¥ä½¿ç”¨é¢„ç®—åˆ†æåŠŸèƒ½');
                return;
            }
            
            const planId = parseInt(document.getElementById('expensePlanId').value);
            
            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†è®¡åˆ’
            if (!planId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ—…è¡Œè®¡åˆ’');
                return;
            }
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const analysisResultDiv = document.getElementById('budgetAnalysisResult');
                analysisResultDiv.style.display = 'block';
                analysisResultDiv.innerHTML = '<p>æ­£åœ¨åˆ†æé¢„ç®—ï¼Œè¯·ç¨å€™...</p>';
                
                const response = await fetch('/api/budget/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        plan_id: planId,
                        expenses: [] // åç«¯ä¼šè·å–å®é™…çš„å¼€é”€æ•°æ®
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // æ˜¾ç¤ºåˆ†æç»“æœ
                        analysisResultDiv.innerHTML = result.analysis.replace(/\n/g, '<br>');
                    } else {
                        analysisResultDiv.innerHTML = '<p>é¢„ç®—åˆ†æå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯') + '</p>';
                    }
                } else {
                    const error = await response.json();
                    analysisResultDiv.innerHTML = '<p>é¢„ç®—åˆ†æå¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯') + '</p>';
                }
            } catch (error) {
                console.error('Error analyzing budget:', error);
                document.getElementById('budgetAnalysisResult').innerHTML = '<p>é¢„ç®—åˆ†ææ—¶å‘ç”Ÿé”™è¯¯: ' + error.message + '</p>';
            }
        });
    </script>
</body>
</html>