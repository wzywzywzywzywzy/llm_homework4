name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  release:
    types: [published]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: Login to Alibaba Cloud Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v2
      with:
        registry: crpi-4i2pz1sdtuxmovzx.cn-hangzhou.personal.cr.aliyuncs.com
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          crpi-4i2pz1sdtuxmovzx.cn-hangzhou.personal.cr.aliyuncs.com/ai_traveller/ai_traveller_doc:latest
          crpi-4i2pz1sdtuxmovzx.cn-hangzhou.personal.cr.aliyuncs.com/ai_traveller/ai_traveller_doc:${{ github.sha }}
    
    - name: Build local Docker image for release
      if: github.event_name == 'release'
      run: |
        echo "Building Docker image..."
        docker build -t ai-travel-planner:latest .
        echo "Docker image built successfully!"
        docker images | grep ai-travel-planner
    
    - name: Save Docker image as artifact
      if: github.event_name == 'release'
      run: |
        echo "Saving Docker image as tar.gz..."
        docker save ai-travel-planner:latest | gzip > ai-travel-planner.tar.gz
        ls -la ai-travel-planner.tar.gz
        echo "Docker image saved successfully!"
    
    - name: Upload Docker image as release asset
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./ai-travel-planner.tar.gz
        asset_name: ai-travel-planner.tar.gz
        asset_content_type: application/gzip